create or replace function update_account_balance()
returns trigger as $$
declare
    current_balance numeric;
begin

    select balance into current_balance
    from accounts
    where id = new.account_id;

    if tg_op = 'INSERT' then

        if new.type = 'expense' then

            if current_balance < new.amount then
                raise exception 'Insufficient funds';
            end if;

            update accounts
            set balance = balance - new.amount
            where id = new.account_id;

        elsif new.type = 'income' then

            update accounts
            set balance = balance + new.amount
            where id = new.account_id;

        end if;

        return new;
    end if;

    return null;
end;
$$ language plpgsql;

drop trigger if exists trigger_update_balance on transactions;

create trigger trigger_update_balance
after insert on transactions
for each row
execute function update_account_balance();
